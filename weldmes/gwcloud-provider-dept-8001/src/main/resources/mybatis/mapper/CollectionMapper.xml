<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.gw.equipment.collection.dao.CollectionDao">

    <resultMap id="collection" type="com.gw.entities.MachineGatherInfo">
        <id property="id"  column="id"></id>
        <result property="gatherNo" column="gather_no"></result>
        <result property="status" column="status"></result>
        <result property="deptId" column="dept_id"></result>
        <result property="productionDate" column="production_date"></result>
        <result property="ipPath" column="ip_path"></result>
        <result property="macPath" column="mac_path"></result>
        <result property="protocol" column="protocol"></result>
        <result property="createBy" column="create_by"></result>
        <result property="createTime" column="create_time"></result>
        <result property="lastUpdateBy" column="lastUpdate_by"></result>
        <result property="lastUpdateTime" column="lastUpdate_time"></result>
      <association property="sysDictionary" javaType="com.gw.entities.SysDictionary">
            <id property="id" column="id"></id>
            <result property="type" column="type"></result>
            <result property="typeName" column="type_name"></result>
            <result property="value" column="value"></result>
            <result property="valueName" column="value_name"></result>
          <result property="valueNames" column="value_names"></result>
            <result property="remarks" column="remarks"></result>
        </association>
        <association property="sysDept" javaType="com.gw.entities.SysDept">
            <id property="id" column="id"></id>
            <result property="name" column="name"></result>
            <result property="parentId" column="parent_id"></result>
        </association>
    </resultMap>

    <select id="getList" resultMap="collection">
        select
	        m.id,m.gather_no,m.dept_id,m.ip_path,
	        m.mac_path,m.create_time,m.`status`,
	        m.protocol,d.type,d.value_name,dic.`value`,
	        dic.value_name value_names,s.`name`
        from machine_gather_info m
	    left join sys_dictionary d on m.status = d.id
	    left join sys_dictionary dic on m.protocol = dic.id
	    left join sys_dept s on m.dept_id=s.id
        <where>
            <if test="grade != null and grade != ''">
                and m.dept_id = #{grade}
            </if>
            <if test="gatherNo != null and gatherNo != ''">
                and m.gather_no = #{gatherNo}
            </if>
        </where>
    </select>

    <!--采集信息新增-->
    <insert id="addCollection" parameterType="com.gw.entities.MachineGatherInfo">
        insert into machine_gather_info(gather_no,dept_id,status,protocol,ip_path,mac_path,production_date,create_time)
        values (#{machineGatherInfo.gatherNo},#{machineGatherInfo.deptId},#{machineGatherInfo.status},#{machineGatherInfo.protocol},
                #{machineGatherInfo.ipPath},#{machineGatherInfo.macPath},#{machineGatherInfo.productionDate},#{machineGatherInfo.createTime})
        ON DUPLICATE KEY UPDATE
         gather_no = #{machineGatherInfo.gatherNo},
         dept_id = #{machineGatherInfo.deptId},
         status = #{machineGatherInfo.status},
         protocol = #{machineGatherInfo.protocol},
         ip_path = #{machineGatherInfo.ipPath},
         mac_path = #{machineGatherInfo.macPath},
         last_update_time = #{machineGatherInfo.createTime}
    </insert>

    <delete id="deleteCollection">
        delete from machine_gather_info where id=#{id}
    </delete>

    <select id="getById" resultType="com.gw.entities.MachineGatherInfo">
        select id,gather_no,dept_id,`status`,protocol,ip_path,mac_path,create_time
        from machine_gather_info
        where id =#{id}
    </select>

    <update id="updateCollection" parameterType="com.gw.entities.MachineGatherInfo">
        update machine_gather_info
        <trim prefix="set" suffixOverrides=",">
            <if test="machineGatherInfo.gatherNo != null and machineGatherInfo.gatherNo !=''">gather_no=#{machineGatherInfo.gatherNo},</if>
            <if test="machineGatherInfo.deptId != null and machineGatherInfo.deptId !=''">dept_id=#{machineGatherInfo.deptId},</if>
            <if test="machineGatherInfo.status != null and machineGatherInfo.status !=''">status=#{machineGatherInfo.status},</if>
            <if test="machineGatherInfo.protocol != null and machineGatherInfo.protocol !=''">protocol=#{machineGatherInfo.protocol},</if>
            <if test="machineGatherInfo.createTime != null and machineGatherInfo.createTime !=''">create_time=#{machineGatherInfo.createTime},</if>
            ip_path=#{machineGatherInfo.ipPath},
            mac_path=#{machineGatherInfo.macPath},
        </trim>
        where id=#{machineGatherInfo.id}
    </update>

    <!--采集信息excel导入数据库  采集编号不存在-新增 存在-更新 -->
    <insert id="save">
       insert into machine_gather_info(gather_no,dept_id,status,protocol,ip_path,mac_path,create_time)
       values (#{gatherNo},#{deptId},#{status},#{protocol},#{ipPath},#{macPath},#{createTime})
       ON DUPLICATE KEY UPDATE
        gather_no = #{machineGatherInfo.gatherNo},
        dept_id = #{machineGatherInfo.deptId},
        status = #{machineGatherInfo.status},
        protocol = #{machineGatherInfo.protocol},
        ip_path = #{machineGatherInfo.ipPath},
        mac_path = #{machineGatherInfo.macPath},
        last_update_time = #{machineGatherInfo.createTime}
    </insert>

    <select id="getDeptId" resultType="java.lang.Long">
        select id from sys_dept where `name`=#{name}
    </select>

    <select id="getStatus" resultType="java.lang.Integer">
        select id from sys_dictionary where value_name=#{valueName}
    </select>

    <select id="getProtocol" resultType="java.lang.Integer">
        select id from sys_dictionary where value_name=#{valueNames}
    </select>

    <!--获取采集序号列表-->
    <select id="queryGatherNos" resultMap="collection">
    select
	machine_gather_info.id,
	machine_gather_info.gather_no
    from
	machine_gather_info
    where
	NOT FIND_IN_SET( machine_gather_info.id, ( select GROUP_CONCAT( g_id ) from machine_weld_info ) )
    </select>

    <!--判断采集编号是否存在-->
    <select id="judgeGatherNoYesOrNo" resultType="java.lang.Integer">
        select (1) from machine_gather_info where gather_no = #{GatherNo} and id != #{id}
    </select>
</mapper>
