<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.gw.data.productionTask.dao.ProductionTaskDao">

    <resultMap id="weldStatisticsData" type="com.gw.entities.WeldStatisticsData">
        <id property="id"  column="id"></id>
        <result property="weldModel" column="weldModel"></result>
        <result property="gatherNo" column="gatherNo"></result>
        <result property="welderNo" column="welderNo"></result>
        <result property="weldStatus" column="weldStatus"></result>
        <result property="weldDuration" column="weldDuration"></result>
        <result property="machineId" column="machineId"></result>
        <result property="machineNo" column="machineNo"></result>
        <result property="machineDeptId" column="machineDeptId"></result>
        <result property="gatherId" column="gatherId"></result>
        <result property="gatherDeptId" column="gatherDeptId"></result>
        <result property="welderId" column="welderId"></result>
        <result property="welderName" column="welderName"></result>
        <result property="welderDeptId" column="welderDeptId"></result>
        <result property="taskId" column="taskId"></result>
        <result property="taskName" column="taskName"></result>
        <result property="taskNo" column="taskNo"></result>
        <result property="createTime" column="createTime"></result>
        <result property="startTime" column="startTime"></result>
        <result property="endTime" column="endTime"></result>
        <result property="electricity" column="electricity"></result>
        <result property="voltage" column="voltage"></result>
        <result property="wireFeedRate" column="wireFeedRate"></result>
        <result property="wireDiameter" column="wireDiameter"></result>
        <result property="wireMaterialsGases" column="wireMaterialsGases"></result>
        <result property="count" column="count"></result>
        <result property="count2" column="count2"></result>
        <result property="count3" column="count3"></result>
        <result property="count4" column="count4"></result>
        <result property="count5" column="count5"></result>
        <result property="utilization" column="utilization"></result>
        <result property="time" column="time"></result>
        <result property="time2" column="time2"></result>
        <result property="utilization2" column="utilization2"></result>
        <association property="sysDept" javaType="com.gw.entities.SysDept">
            <id property="id" column="id"></id>
            <result property="name" column="name"></result>
            <result property="parentId" column="parent_id"></result>
        </association>
        <association property="taskInfo" javaType="com.gw.entities.TaskInfo">
            <id property="id" column="id"></id>
            <result property="taskNo" column="task_no"></result>
            <result property="status" column="status"></result>
            <result property="realityStarttime" column="reality_starttime"></result>
            <result property="realityEndtime" column="reality_endtime"></result>
        </association>
        <association property="welderInfo" javaType="com.gw.entities.WelderInfo">
            <id property="id"  column="id"></id>
            <result property="welderName" column="welder_name"></result>
            <result property="welderNo" column="welder_no"></result>
            <result property="deptId" column="dept_id"></result>
            <result property="gender" column="gender"></result>
            <result property="cellphone" column="cellphone"></result>
            <result property="rank" column="rank"></result>
            <result property="certification" column="certification"></result>
            <result property="remarks" column="remarks"></result>
            <result property="status" column="status"></result>
        </association>
    </resultMap>
    <select id="getList" resultMap="weldStatisticsData">
        select
        a.*,
        b.*,
        c.*,
        cast(a.time / c.time3 * 100 as decimal ( 13, 2 )) utilization
        from
        (select
        wsd.welderId,
        s.NAME,
        s.parent_id,
        wsd.welderNo,
        w.welder_name,
        wsd.machineNo,
        wsd.taskNo,
        t.reality_starttime,
        t.reality_endtime,
        SEC_TO_TIME(
        count( wsd.welderId )) time
        from
        weld_statistics_data wsd,
        sys_dept s,
        welder_info w,
        task_info t
        <where>
            wsd.welderDeptId = s.id
            and wsd.taskId = t.id
            and wsd.welderId = w.id
            and ( wsd.weldStatus = 3 or wsd.weldStatus = 5 or wsd.weldStatus = 7 )
            <if test="time1!=null and time1!=''">
                and wsd.startTime &gt;= #{time1}
            </if>
            <if test="time2!=null and time2!=''">
                and wsd.endTime &lt;= #{time2}
            </if>
            <if test="areaId!=null and areaId!=''">
                and s.parent_id = #{areaId}
            </if>
            <if test="teamName!=null and teamName!=''">
                and s.name = #{teamName}
            </if>
            <if test="welderNo!=null and welderNo!=''">
                and wsd.welderNo = #{welderNo}
            </if>
            <if test="junctionNo!=null and junctionNo!=''">
                and wsd.taskNo = #{junctionNo}
            </if>
        </where>
        group by
        wsd.welderId,
        wsd.taskNo)a,
        (select
        wsd.welderId,
        wsd.taskNo,
        SEC_TO_TIME(
        count( case when wsd.weldStatus = 99  then 1 else null end )) time2,
        wsd.electricity,
        wsd.voltage
        from
        weld_statistics_data wsd,
        welder_info w,
        task_info t
        where
        wsd.welderId = w.id
        and wsd.taskId = t.id
        group by
        wsd.welderId,
        wsd.taskNo
        )b,(
        select
        wsd.welderId,
        wsd.taskNo,
        SEC_TO_TIME(
        count( case when wsd.weldStatus = 3 or wsd.weldStatus = 5 or wsd.weldStatus = 7 or wsd.weldStatus = 99  then 1 else null end )) time3
        from
        weld_statistics_data wsd,
        welder_info w,
        task_info t
        where
        wsd.welderId = w.id
        and wsd.taskId = t.id
        group by
        wsd.welderId,
        wsd.taskNo
        )c
        where
        a.welderId=b.welderId
        and
        a.taskNo=b.taskNo
        and
        a.welderId=c.welderId
        and
        a.taskNo=c.taskNo
    </select>
    <select id="getTeamName" resultType="java.lang.String">
        select name from sys_dept where id=#{teamId}
    </select>
</mapper>