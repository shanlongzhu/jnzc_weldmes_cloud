<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.gw.data.device.dao.DeviceDao">
    <resultMap id="realtimeData" type="com.gw.entities.RealtimeData">
    <id property="id"  column="id"></id>
    <result property="fwelderId" column="fwelder_id"></result>
    <result property="fgatherNo" column="fgather_no"></result>
    <result property="fmachineId" column="fmachine_id"></result>
    <result property="fjunctionId" column="fjunction_id"></result>
    <result property="fItemId" column="fitemid"></result>
    <result property="fElectricity" column="felectricity"></result>
    <result property="fVoltage" column="fvoltage"></result>
    <result property="fRateOfFlow" column="frate_of_flow"></result>
    <result property="fStatus" column="fstatus"></result>
    <result property="fWelderNo" column="fwelder_no"></result>
    <result property="fJunctionNo" column="fjunction_no"></result>
    <result property="fWeldNo" column="fweld_no"></result>
    <result property="fChannel" column="fchannel"></result>
    <result property="fMaxElectricity" column="fmax_electricity"></result>
    <result property="fMinElectricity" column="fmin_electricity"></result>
    <result property="fMaxVoltage" column="fmax_voltage"></result>
    <result property="fMinVoltage" column="fmin_voltage"></result>
    <result property="fWelderItemId" column="fwelder_itemid"></result>
    <result property="fJunctionItemId" column="fjunction_itemid"></result>
    <result property="fMachineItemId" column="fmachine_itemid"></result>
    <result property="fWireFeedRate" column="fwirefeedrate"></result>
    <result property="fWeldingRate" column="fweldingrate"></result>
    <result property="fMachineModel" column="fmachinemodel"></result>
    <result property="fWireDiameter" column="fwirediameter"></result>
    <result property="fMaterialGas" column="fmaterialgas"></result>
    <result property="fWeldTime" column="fweldtime"></result>
        <result property="fWeldTime2" column="fweldtime2"></result>
    <result property="fSolderLayer" column="fsolder_layer"></result>
    <result property="fWeldBead" column="fweld_bead"></result>
    <result property="count" column="count"></result>
    <result property="utilization" column="utilization"></result>
    <result property="time" column="time"></result>
    <result property="time2" column="time2"></result>
    <association property="sysDept" javaType="com.gw.entities.SysDept">
        <id property="id" column="id"></id>
        <result property="name" column="name"></result>
        <result property="parentId" column="parent_id"></result>
    </association>
    <association property="machineWeldInfo" javaType="com.gw.entities.MachineWeldInfo">
        <id property="id"  column="id"></id>
        <result property="machineNo" column="machine_no"></result>
        <result property="status" column="status"></result>
        <result property="type" column="type"></result>
        <result property="firm" column="firm"></result>
        <result property="model" column="model"></result>
        <result property="deptId" column="dept_id"></result>
        <result property="gId" column="g_id"></result>
        <result property="isNetwork" column="is_network"></result>
        <result property="createTime" column="create_time"></result>
    </association>
</resultMap>
    <select id="getList" resultMap="realtimeData">
    select
    a.*,
    b.*,
    c.*,
    d.*,
    cast(c.time / d.time2 *100 as decimal (13,2)) utilization
    from
    (
    select distinct
    m.machine_no,
    s.NAME,
    s.parent_id
    from
    machine_weld_info m,
    sys_dept s,
    realtime_data r
        <where>
        m.dept_id = s.id
        and m.id = r.fmachine_id
        <if test="time1!=null and time1!=''">
            and r.fWeldTime &gt;= #{time1}
        </if>
        <if test="time2!=null and time2!=''">
            and r.fWeldTime &lt;= #{time2}
        </if>
            <if test="areaId!=null and areaId!=''">
                and s.parent_id = #{areaId}
            </if>
            <if test="teamName!=null and teamName!=''">
                and s.name = #{teamName}
            </if>
    </where>
    ) a,(
    select
    count( r.fmachine_id ) count,
    m.machine_no
    from
    realtime_data r,
    machine_weld_info m
    where
    r.fjunction_id != 0
    and r.fmachine_id = m.id
    group by
    m.machine_no
    ) b,
    (
    select
    SEC_TO_TIME(
    count( r.id )) time,
    m.machine_no
    from
    realtime_data r,
    machine_weld_info m
    where
    r.fmachine_id = m.id
    and ( r.fstatus = 3 or r.fstatus = 99 )
    group by
    m.machine_no
    ) c,
    (
    select
    SEC_TO_TIME(
    count( r.id )) time2,
    m.machine_no
    from
    realtime_data r,
    machine_weld_info m
    where
    r.fmachine_id = m.id
    and (
    r.fstatus = 0
    or r.fstatus = 3
    or r.fstatus = 5
    or r.fstatus = 7
    or r.fstatus = 99
    )
    group by
    m.machine_no
    ) d
    where
    a.machine_no = b.machine_no
    and a.machine_no = c.machine_no
    and a.machine_no = d.machine_no
    </select>
    <select id="getTeamName" resultType="java.lang.String">
         select name from sys_dept where id=#{teamId}
    </select>

</mapper>