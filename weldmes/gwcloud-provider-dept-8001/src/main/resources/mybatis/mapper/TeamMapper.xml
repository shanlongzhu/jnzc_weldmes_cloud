<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.gw.data.team.dao.TeamDao">

    <resultMap id="realtimeData" type="com.gw.entities.RealtimeData">
    <id property="id"  column="id"></id>
    <result property="fWelderId" column="fwelder_id"></result>
    <result property="fGatherNo" column="fgather_no"></result>
    <result property="fMachineId" column="fmachine_id"></result>
    <result property="fJunctionId" column="fjunction_id"></result>
    <result property="fItemId" column="fitemid"></result>
    <result property="fElectricity" column="felectricity"></result>
    <result property="fVoltage" column="fvoltage"></result>
    <result property="fRateOfFlow" column="frate_of_flow"></result>
    <result property="fStatus" column="fstatus"></result>
        <result property="fWelderNo" column="fwelder_no"></result>
        <result property="fJunctionNo" column="fjunction_no"></result>
        <result property="fWeldNo" column="fweld_no"></result>
        <result property="fChannel" column="fchannel"></result>
        <result property="fMaxElectricity" column="fmax_electricity"></result>
        <result property="fMinElectricity" column="fmin_electricity"></result>
        <result property="fMaxVoltage" column="fmax_voltage"></result>
        <result property="fMinVoltage" column="fmin_voltage"></result>
        <result property="fWelderItemId" column="fwelder_itemid"></result>
        <result property="fJunctionItemId" column="fjunction_itemid"></result>
        <result property="fMachineItemId" column="fmachine_itemid"></result>
        <result property="fWireFeedRate" column="fwirefeedrate"></result>
        <result property="fWeldingRate" column="fweldingrate"></result>
        <result property="fMachineModel" column="fmachinemodel"></result>
        <result property="fWireDiameter" column="fwirediameter"></result>
        <result property="fMaterialGas" column="fmaterialgas"></result>
        <result property="fWeldTime" column="fweldtime"></result>
        <result property="fSolderLayer" column="fsolder_layer"></result>
        <result property="fWeldBead" column="fweld_bead"></result>
        <result property="count" column="count"></result>
        <result property="count2" column="count2"></result>
        <result property="count3" column="count3"></result>
        <result property="count4" column="count4"></result>
        <result property="count5" column="count5"></result>
        <result property="utilization" column="utilization"></result>
        <result property="time" column="time"></result>
        <result property="time2" column="time2"></result>
        <result property="utilization2" column="utilization2"></result>
    <association property="sysDept" javaType="com.gw.entities.SysDept">
        <id property="id" column="id"></id>
        <result property="name" column="name"></result>
    </association>
        <association property="machineWeldInfo" javaType="com.gw.entities.MachineWeldInfo">
            <id property="id"  column="id"></id>
            <result property="machineNo" column="machine_no"></result>
            <result property="status" column="status"></result>
            <result property="type" column="type"></result>
            <result property="firm" column="firm"></result>
            <result property="model" column="model"></result>
            <result property="deptId" column="dept_id"></result>
            <result property="gId" column="g_id"></result>
            <result property="isNetwork" column="is_network"></result>
            <result property="createTime" column="create_time"></result>
        </association>
    </resultMap>


    <select id="getList" resultMap="realtimeData">
    select
	a.*,
	b.*,
	c.*,
	d.*,
	e.*,
	f.*,
	g.*,
	cast(b.count2 / a.count * 100 as decimal (13,2)) utilization,
	cast(f.time/g.time2*100 as decimal (13,2)) utilization2
    from
	(
	select
		count( fmachine_id ) count,
		s.`name`
	from
		realtime_data r,
		sys_dept s
		<where>
			r.fmachine_itemid = s.id
			<if test="time1!=null and time1!=''">
				and r.fWeldTime &gt;= #{time1}
			</if>
			<if test="time2!=null and time2!=''">
				and r.fWeldTime &lt;= #{time2}
			</if>
		</where>
	group by
		fmachine_itemid
	) a,
	(
	select
		count( m.id ) count2,
		s.`name`
	from
		machine_weld_info m,
		sys_dept s
	where
		m.dept_id = s.id
	group by
		s.`name`
		) b,(
	select
		count( r.id ) count3,
		s.`name`
	from
		realtime_data r,
		sys_dept s
	where
		r.fmachine_itemid = s.id
		and ( r.fstatus = 3 or r.fstatus = 5 or r.fstatus = 7 or r.fstatus = 99 )
	group by
		s.`name`
	) c,(
	select distinct
	count(r.fmachine_id) count4,
	s.`name`
    from
	realtime_data r,
	sys_dept s
    where
	r.fjunction_id = 0
    and r.fmachine_itemid=s.id
    group by
    s.`name`
	) d,(
	select distinct
	count(r.fmachine_id) count5,
	s.`name`
    from
	realtime_data r,
	sys_dept s
    where
	r.fjunction_id != 0
    and r.fmachine_itemid=s.id
    group by
    s.`name`
	)e,(
	select
	SEC_TO_TIME(count( r.id )) time,
	s.`name`
    from
	realtime_data r,
	sys_dept s
    where
	r.fmachine_itemid = s.id
	and ( r.fstatus = 3 or r.fstatus = 99 )
    group by
	s.`name`
	)f,(
	select
	SEC_TO_TIME(count( r.id )) time2,
	s.`name`
    from
	realtime_data r,
	sys_dept s
    where
	r.fmachine_itemid = s.id
	and ( r.fstatus = 0 or r.fstatus = 3 or r.fstatus = 5 or r.fstatus = 7 or r.fstatus = 99 )
    group by
	s.`name`
	)g
    where
	a.`name` = b.`name`
	and a.`name` = c.`name`
	and a.`name`=d.`name`
	and a.name=e.name
	and a.`name`=f.`name`
	and a.`name`=g.`name`
    </select>

</mapper>